{% extends "base.html" %}

{% block content %}
<section class="page-section portfolio">
    <div class="container">
        <div class="text-center">
            <h2 class="page-section-heading text-secondary mb-0 d-inline-block">League Roster</h2>
        </div>
        <div class="divider-custom">
            <div class="divider-custom-line"></div>
            <div class="divider-custom-icon"><svg class="svg-inline--fa fa-star fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="star" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M259.3 17.8L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0z"></path></svg></div>
            <div class="divider-custom-line"></div>
        </div>

         <div class="d-flex justify-content-between align-items-center mb-3">
            <button id="clearFilters" class="btn btn-outline-warning btn-sm">
                Clear filters
            </button>
            <div id="activeFilters" class="d-flex flex-wrap gap-2"></div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle" id="playersTable">
                <thead>
                    <tr id="playersHeaderRow"></tr>
                </thead>
                <tbody id="playersBody"></tbody>
            </table>
        </div>
    </div>
</section>
<!-- Player Detail Modal -->
<div class="portfolio-modal modal fade" id="playerModal" tabindex="-1" role="dialog"
     aria-labelledby="playerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content position-relative">
            <!-- Close button (top-right) -->
            <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fas fa-times"></i></span></button>

            <div class="modal-body text-center">
                <div class="container">
                    <div class="row justify-content-center">
                        <!-- Short summary line -->
                            <p id="playerSummary" class="mb-4 text-muted">
                                <!-- Filled by JS -->
                            </p>
                        <div class="col-lg-8">
                            <!-- Title -->
                            <h2 class="portfolio-modal-title text-secondary mb-0"
                                id="playerModalLabel">
                                Player Details
                            </h2>

                            <!-- Icon Divider -->
                            <div class="divider-custom">
                                <div class="divider-custom-line"></div>
                                <div class="divider-custom-icon">
                                    <svg class="svg-inline--fa fa-star fa-w-18" aria-hidden="true"
                                         focusable="false" data-prefix="fas" data-icon="star"
                                         role="img" xmlns="http://www.w3.org/2000/svg"
                                         viewBox="0 0 576 512">
                                        <path fill="currentColor"
                                              d="M259.3 17.8L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0z">
                                        </path>
                                    </svg>
                                </div>
                                <div class="divider-custom-line"></div>
                            </div>

                            <!-- Detailed info -->
                            <table class="table table-bordered text-center align-middle mt-3 player-detail-table">
                                <tbody id="playerDetails"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const headerRow      = document.getElementById("playersHeaderRow");
    const body           = document.getElementById("playersBody");
    const activeFiltersEl= document.getElementById("activeFilters");
    const clearFiltersBtn= document.getElementById("clearFilters");

    const modalEl        = document.getElementById("playerModal");
    const modalTitle     = document.getElementById("playerModalLabel");
    const modalDetails   = document.getElementById("playerDetails");
    const playerSummary  = document.getElementById("playerSummary");
    let   bsModal        = null;

    // ðŸ‘‰ Only show these columns in the table
    const VISIBLE_COLUMNS = [
        "Player",
        "Team",
        "Age",
        "Position",
        "Country"
    ];

    if (window.bootstrap && bootstrap.Modal) {
        bsModal = new bootstrap.Modal(modalEl);
    }

    let allPlayers = [];
    let columns    = [];
    let filters    = {}; // { columnName: value }

    // -------- Fetch data --------
    fetch("/api/players")
        .then(res => res.json())
        .then(data => {
            allPlayers = data || [];
            if (!allPlayers.length) {
                body.innerHTML = `
                    <tr>
                        <td class="text-center text-muted">No player data available.</td>
                    </tr>`;
                return;
            }

            // Only show VISIBLE columns please :)
            columns = VISIBLE_COLUMNS.filter(c => c in allPlayers[0]);
            buildHeader();
            buildBody();
            updateActiveFilters();
        })
        .catch(err => {
            console.error("Error loading players:", err);
            body.innerHTML = `
                <tr>
                    <td class="text-center text-danger">
                        Error loading player data.
                    </td>
                </tr>`;
        });

    // -------- Build table header with per-column filter dropdowns --------
    function buildHeader() {
        headerRow.innerHTML = "";

        columns.forEach(col => {
            // Collect unique values for this column
            const uniqueValues = Array.from(
                new Set(
                    allPlayers
                        .map(p => p[col])
                        .filter(v => v !== null && v !== undefined && v !== "")
                )
            ).sort((a, b) => String(a).localeCompare(String(b)));

            const th = document.createElement("th");

            // NO FILTER for Full Name column
            if (col === "Player") {
                th.innerHTML = `
                    <div class="d-flex align-items-center justify-content-between gap-2">
                        <span>${col}</span>
                    </div>
                `;
            } else {
                // Normal filter for all other columns
                const safeUniqueValues = uniqueValues.map(v => ({
                    raw: v,
                    html: String(v).replace(/"/g, "&quot;")
                }));

                th.innerHTML = `
                    <div class="d-flex align-items-center justify-content-between gap-2">
                        <span>${col}</span>
                        <div class="btn-group">
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                Filter
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" data-column="${col}">
                                <li>
                                    <button class="dropdown-item" data-value="">
                                        All
                                    </button>
                                </li>
                                ${safeUniqueValues.map(v => `
                                    <li>
                                        <button class="dropdown-item" data-value="${v.html}">
                                            ${v.raw}
                                        </button>
                                    </li>
                                `).join("")}
                            </ul>
                        </div>
                    </div>
                `;
            }

            headerRow.appendChild(th);
            });

        // Attach listeners to dropdown menus
        headerRow.querySelectorAll(".dropdown-menu").forEach(menu => {
            menu.addEventListener("click", (e) => {
                const btn = e.target.closest("button.dropdown-item");
                if (!btn) return;

                const col = menu.getAttribute("data-column");
                const encodedVal = btn.getAttribute("data-value");

                if (!encodedVal) {
                    delete filters[col];
                } else {
                    filters[col] = btn.textContent.trim();
                }
                console.log("FILTERS:", filters);
                buildBody();
                updateActiveFilters();
            });
        });
    }

    // -------- Build table body (filtered rows) --------
    function buildBody() {
        body.innerHTML = "";

        const filtered = allPlayers.filter(player => {
            return Object.entries(filters).every(([col, val]) => {
                const cell = player[col];

                if (cell === null || cell === undefined) return false;

                // strict numeric compare
                if (typeof cell === "number") {
                    return Number(cell) === Number(val);
                }

                // strict string compare (case + whitespace safe)
                return String(cell).trim().toLowerCase() ===
                       String(val).trim().toLowerCase();
            });
        });

        if (!filtered.length) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = columns.length || 1;
            td.className = "text-center text-muted";
            td.textContent = "No players match the current filters.";
            tr.appendChild(td);
            body.appendChild(tr);
            return;
        }

        filtered.forEach(player => {
            const tr = document.createElement("tr");

            columns.forEach(col => {
                const td = document.createElement("td");
                const value = player[col];

                // Make player name clickable to open modal
                if (col === "Player") {
                    const a = document.createElement("a");
                    a.href = "#";
                    a.textContent = value || "(no name)";
                    a.addEventListener("click", (e) => {
                        e.preventDefault();
                        showPlayerDetails(player);
                    });
                    td.appendChild(a);
                } else {
                    td.textContent = value;
                }

                tr.appendChild(td);
            });

            body.appendChild(tr);
        });
    }

    // Format DOB, Height and Weight
    function formatDateLong(dateStr) {
        if (!dateStr) return "";

        const d = new Date(dateStr);
        if (isNaN(d)) return dateStr;

        return d.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric"
        });
    }
    function formatHeight(heightStr) {
        if (!heightStr) return "";

        // "6-8" -> feet=6, inches=8
        const [feet, inches] = heightStr.split("-").map(Number);
        if (isNaN(feet) || isNaN(inches)) return heightStr;

        // Convert to meters (1 inch = 2.54 cm)
        const totalInches = feet * 12 + inches;
        const meters = (totalInches * 2.54 / 100).toFixed(2);

        return `${feet}'${inches}" (${meters} m)`;
    }

    function formatWeight(lbs) {
        if (!lbs) return "";
        const kg = (lbs * 0.453592).toFixed(0);
        return `${lbs} lb (${kg} kg)`;
    }

// -------- Show modal with full player details --------
function showPlayerDetails(player) {
    const name    = player["Player"] || "Player details";
    const team    = player.Team || "";
    const pos     = player.Position || "";
    const jersey  = player.Jersey ? "#" + player.Jersey : "";

    // Modal title
    modalTitle.textContent = name;

    // Build summary line
    const summaryParts = [];
    if (team) summaryParts.push(team);
    if (jersey) summaryParts.push(jersey);
    if (pos) summaryParts.push(pos);

    if (playerSummary) {
        playerSummary.textContent = summaryParts.join(" Â· ");
    }

    // ---- STATIC INFO TABLE ----
    const tableDataStatic = [
        ["Height", formatHeight(player.Height)],
        ["Weight", formatWeight(player.Weight)],
        ["Country", player.Country],
        ["Last Attended", player["Last Attended"]],
        ["Age", player.Age ? `${player.Age} years` : ""],
        ["Birthdate", formatDateLong(player["Date of Birth"])],
    ];

    let html = "<table class='table table-sm mb-3'>";
    for (let i = 0; i < tableDataStatic.length; i += 3) {
        html += "<tr>";
        for (let j = 0; j < 3; j++) {
            const cell = tableDataStatic[i + j];
            if (!cell) continue;
            html += `
                <td>
                    <div class="stat-label">${cell[0]}</div>
                    <div class="stat-value">${cell[1] ?? ""}</div>
                </td>
            `;
        }
        html += "</tr>";
    }
    html += "</table>";
    modalDetails.innerHTML = html;

    // ---- FETCH PLAYER DYNAMIC BOX SCORE STATS ----
    fetch(`/api/player-averages/${encodeURIComponent(name)}`)
        .then(res => {
            if (!res.ok) throw new Error("Player stats not found");
            return res.json();
        })
        .then(stats => {
            const tableDataDynamic = [
                ["Points", stats.points],
                ["Assists", stats.assists],
                ["Total Rebounds", stats.reboundstotal],
                ["Offensive Rebounds", stats.reboundsoffensive],
                ["Defensive Rebounds", stats.reboundsdefensive],
                ["FG Made", stats.fieldgoalsmade],
                ["FG Attempted", stats.fieldgoalsattempted],
                ["FG%", stats.fieldgoalspercentage != null ? (stats.fieldgoalspercentage * 100).toFixed(1) + "%" : ""],
                ["3PT Made", stats.threepointersmade],
                ["3PT Attempted", stats.threepointersattempted],
                ["3PT%", stats.threepointerspercentage != null ? (stats.threepointerspercentage * 100).toFixed(1) + "%" : ""],
                ["FT Made", stats.freethrowsmade],
                ["FT Attempted", stats.freethrowsattempted],
                ["FT%", stats.freethrowspercentage != null ? (stats.freethrowspercentage * 100).toFixed(1) + "%" : ""],
                ["Steals", stats.steals],
                ["Blocks", stats.blocks],
                ["Turnovers", stats.turnovers],
                ["Personal Fouls", stats.foulspersonal],
                ["+/-", stats.plusminuspoints]
            ];

            html += "<table class='table table-sm'>";
            for (let i = 0; i < tableDataDynamic.length; i += 3) {
                html += "<tr>";
                for (let j = 0; j < 3; j++) {
                    const cell = tableDataDynamic[i + j];
                    if (!cell) continue;
                    html += `
                        <td>
                            <div class="stat-label">${cell[0]}</div>
                            <div class="stat-value">${cell[1] ?? ""}</div>
                        </td>
                    `;
                }
                html += "</tr>";
            }
            html += "</table>";

            modalDetails.innerHTML = html;
        })
        .catch(err => {
            console.error("Error fetching player stats:", err);
            modalDetails.innerHTML += `
                <tr>
                    <td colspan="3" class="text-center text-muted">
                        No stats available
                    </td>
                </tr>
            `;
        });

    if (bsModal) bsModal.show();
}





    // -------- Active filters badges --------
    function updateActiveFilters() {
        activeFiltersEl.innerHTML = "";

        const entries = Object.entries(filters);

        if (!entries.length) {
            const span = document.createElement("span");
            span.className = "text-muted";
            span.textContent = "No filters applied";
            activeFiltersEl.appendChild(span);
            return;
        }

        entries.forEach(([col, val]) => {
            const badge = document.createElement("span");
            badge.className = "badge bg-primary d-flex align-items-center gap-1";
            badge.innerHTML = `
                ${col}: ${val}
                <button type="button"
                        class="btn-close btn-close-white btn-sm ms-1"
                        aria-label="Remove"
                        data-column="${col}">
                </button>
            `;
            activeFiltersEl.appendChild(badge);
        });

        activeFiltersEl.querySelectorAll("button.btn-close").forEach(btn => {
            btn.addEventListener("click", () => {
                const col = btn.getAttribute("data-column");
                delete filters[col];
                buildBody();
                updateActiveFilters();
            });
        });
    }

    // -------- Clear all filters button --------
    clearFiltersBtn.addEventListener("click", () => {
        filters = {};
        buildBody();
        updateActiveFilters();
    });
});
</script>
{% endblock %}