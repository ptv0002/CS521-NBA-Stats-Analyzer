{% extends "base.html" %}

{% block content %}
<section class="page-section portfolio">
    <div class="container mt-5">
        <div class="text-center">
            <h2 class="page-section-heading text-secondary mb-0 d-inline-block">League Roster</h2>
        </div>
        <div class="divider-custom">
            <div class="divider-custom-line"></div>
            <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
            <div class="divider-custom-line"></div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <button id="clearFilters" class="btn btn-outline-warning btn-sm">
                Clear filters
            </button>
            <div id="activeFilters" class="d-flex flex-wrap gap-2"></div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle" id="playersTable">
                <thead>
                    <tr id="playersHeaderRow"></tr>
                </thead>
                <tbody id="playersBody"></tbody>
            </table>
        </div>
    </div>
</section>

<!-- Player Detail Modal -->
<div class="portfolio-modal modal fade" id="playerModal" tabindex="-1" role="dialog"
     aria-labelledby="playerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content position-relative">
            <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="fas fa-times"></i></span></button>

            <div class="modal-body text-center">
                <div class="container">
                    <div class="row justify-content-center">
                        <p id="playerSummary" class="mb-3 text-muted " style="font-size: x-large"></p>
                        <div class="col-lg-10">
                            <h2 class="portfolio-modal-title text-secondary mb-0" id="playerModalLabel">
                                Player Details
                            </h2>

                            <div class="divider-custom">
                                <div class="divider-custom-line"></div>
                                <div class="divider-custom-icon"><i class="fas fa-star"></i></div>
                                <div class="divider-custom-line"></div>
                            </div>

                            <!-- Static Info Cards -->
                            <div id="playerDetailCards" class="row g-3 mt-3"></div>

                            <!-- Dynamic NBA Stats Table -->
                            <div class="mt-4 text-start">
                                <h4 class="text-secondary mb-2">2024-2025 Statistics</h4>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm text-center" id="playerDynamicStats">
                                        <thead>
                                            <tr id="dynamicStatsHeader"></tr>
                                        </thead>
                                        <tbody id="dynamicStatsBody"></tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const headerRow = document.getElementById("playersHeaderRow");
    const body = document.getElementById("playersBody");
    const activeFiltersEl = document.getElementById("activeFilters");
    const clearFiltersBtn = document.getElementById("clearFilters");

    const modalEl = document.getElementById("playerModal");
    const modalTitle = document.getElementById("playerModalLabel");
    const playerSummary = document.getElementById("playerSummary");
    const playerDetailCards = document.getElementById("playerDetailCards");
    const dynamicStatsHeader = document.getElementById("dynamicStatsHeader");
    const dynamicStatsBody = document.getElementById("dynamicStatsBody");

    let bsModal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(modalEl) : null;

    const VISIBLE_COLUMNS = ["Player", "Team", "Age", "Position", "Country"];
    let allPlayers = [];
    let filters = {};

    fetch("/api/players").then(r=>r.json()).then(data=>{
        allPlayers = data || [];
        if(!allPlayers.length){
            body.innerHTML=`<tr><td class="text-center text-muted">No player data available.</td></tr>`;
            return;
        }
        buildHeader();
        buildBody();
        updateActiveFilters();
    }).catch(err=>{
        console.error(err);
        body.innerHTML=`<tr><td class="text-center text-danger">Error loading player data.</td></tr>`;
    });

    function buildHeader(){
        headerRow.innerHTML="";
        VISIBLE_COLUMNS.forEach(col=>{
            const th=document.createElement("th");
            if(col==="Player"){ th.innerHTML=col; }
            else{
                const uniqueValues=Array.from(new Set(allPlayers.map(p=>p[col]).filter(v=>v))).sort();
                th.innerHTML=`
                <div class="d-flex justify-content-between align-items-center">
                    <span>${col}</span>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Filter</button>
                        <ul class="dropdown-menu dropdown-menu-end" data-column="${col}">
                            <li><button class="dropdown-item" data-value="">All</button></li>
                            ${uniqueValues.map(v=>`<li><button class="dropdown-item" data-value="${v}">${v}</button></li>`).join("")}
                        </ul>
                    </div>
                </div>`;
            }
            headerRow.appendChild(th);
        });

        headerRow.querySelectorAll(".dropdown-menu").forEach(menu=>{
            menu.addEventListener("click", e=>{
                const btn=e.target.closest("button.dropdown-item");
                if(!btn) return;
                const col=menu.getAttribute("data-column");
                const val=btn.getAttribute("data-value");
                if(!val) delete filters[col];
                else filters[col]=val;
                buildBody();
                updateActiveFilters();
            });
        });
    }

    function buildBody(){
        body.innerHTML="";
        const filtered=allPlayers.filter(player=>Object.entries(filters).every(([col,val])=>{
            const cell=player[col];
            if(cell==null) return false;
            return String(cell).trim().toLowerCase()===String(val).trim().toLowerCase();
        }));

        if(!filtered.length){
            body.innerHTML=`<tr><td colspan="${VISIBLE_COLUMNS.length}" class="text-center text-muted">No players match the current filters.</td></tr>`;
            return;
        }

        filtered.forEach(player=>{
            const tr=document.createElement("tr");
            VISIBLE_COLUMNS.forEach(col=>{
                const td=document.createElement("td");
                if(col==="Player"){
                    const a=document.createElement("a");
                    a.href="#"; a.textContent=player[col];
                    a.addEventListener("click",e=>{e.preventDefault(); showPlayerDetails(player);});
                    td.appendChild(a);
                } else td.textContent=player[col];
                tr.appendChild(td);
            });
            body.appendChild(tr);
        });
    }

    function updateActiveFilters(){
        activeFiltersEl.innerHTML="";
        const entries=Object.entries(filters);
        if(!entries.length){
            const span=document.createElement("span");
            span.className="text-muted"; span.textContent="No filters applied";
            activeFiltersEl.appendChild(span);
            return;
        }
        entries.forEach(([col,val])=>{
            const badge=document.createElement("span");
            badge.className="badge bg-primary d-flex align-items-center gap-1";
            badge.innerHTML=`${col}: ${val} <button type="button" class="btn-close btn-close-white btn-sm ms-1" data-column="${col}"></button>`;
            activeFiltersEl.appendChild(badge);
        });
        activeFiltersEl.querySelectorAll("button.btn-close").forEach(btn=>{
            btn.addEventListener("click",()=>{
                const col=btn.getAttribute("data-column");
                delete filters[col];
                buildBody(); updateActiveFilters();
            });
        });
    }

    clearFiltersBtn.addEventListener("click",()=>{filters={}; buildBody(); updateActiveFilters();});

    function showPlayerDetails(player){
        modalTitle.textContent=player["Player"]||"Player Details";
        playerSummary.textContent=[player.Team,player.Jersey? "#"+player.Jersey:"",player.Position].filter(Boolean).join(" Â· ");

        const staticStats=[
            ["Height", formatHeight(player.Height)],
            ["Weight", formatWeight(player.Weight)],
            ["Country", player.Country],
            ["Age", player.Age?player.Age+" yrs":""],
            ["Birthdate", formatDateLong(player["Date of Birth"])],
            ["Last Attended", player["Last Attended"]]
        ];
        playerDetailCards.innerHTML="";
        staticStats.forEach(([label,value])=>{
            const card=document.createElement("div");
            card.className="col-6 col-md-4 p-2";
            card.innerHTML=`<div class="team-stat-card"><div class="team-stat-label">${label}</div><div class="team-stat-value">${value??""}</div></div>`;
            playerDetailCards.appendChild(card);
        });

        fetch("/api/player_averages")
            .then(res => res.json())
            .then(allStats => {
                const stats = allStats.find(
                    p => p.Player?.toLowerCase() === player["Player"]?.toLowerCase()
                );

                if (!stats) {
                    dynamicStatsBody.innerHTML =
                        "<tr><td colspan='20' class='text-center text-muted'>No stats available</td></tr>";
                    return;
                }

                const statColumns = ["PTS","AST","REB","OREB","DREB","FGM","FGA","FG%","3PM","3PA","3P%","FTM","FTA","FT%","STL","BLK","TO","PF","+/-"];
                const statKeys = [
                    "points","assists","reboundstotal","reboundsoffensive","reboundsdefensive",
                    "fieldgoalsmade","fieldgoalsattempted","fieldgoalspercentage",
                    "threepointersmade","threepointersattempted","threepointerspercentage",
                    "freethrowsmade","freethrowsattempted","freethrowspercentage",
                    "steals","blocks","turnovers","foulspersonal","plusminuspoints"
                ];

                dynamicStatsHeader.innerHTML = "";
                statColumns.forEach(col => {
                    const th = document.createElement("th");
                    th.textContent = col;
                    dynamicStatsHeader.appendChild(th);
                });

                dynamicStatsBody.innerHTML = "";
                const tr = document.createElement("tr");

                statKeys.forEach(key => {
                    let val = stats[key];
                    if (key.endsWith("percentage") && val != null)
                        val = val.toFixed(1) + "%";

                    const td = document.createElement("td");
                    td.textContent = val ?? "";
                    tr.appendChild(td);
                });

                dynamicStatsBody.appendChild(tr);
            })
            .catch(err => {
                console.error(err);
                dynamicStatsBody.innerHTML =
                    "<tr><td colspan='20' class='text-center text-muted'>No stats available</td></tr>";
            });
        if(bsModal) bsModal.show();
    }

    function formatDateLong(dateStr){if(!dateStr)return"";const d=new Date(dateStr);if(isNaN(d))return dateStr;return d.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});}
    function formatHeight(str){if(!str)return"";const [f,i]=str.split("-").map(Number);if(isNaN(f)||isNaN(i))return str;return `${f}'${i}" (${((f*12+i)*2.54/100).toFixed(2)} m)`;}
    function formatWeight(lbs){if(!lbs)return"";return `${lbs} lb (${(lbs*0.453592).toFixed(0)} kg)`;}

});
</script>
{% endblock %}
